<?xml version="1.0" encoding="UTF-8"?>
<mdq:suite xmlns:mdq="https://nceas.ucsb.edu/mdqe">
  <id>arctic.data.center</id>
  <name>Arctic Data Center Quality Suite</name>
  <description>This is a provisional Arctic Data Center Quality Suite. It is modeled after the submission guidelines used on the Arctic Data Center (arcticdata.io).</description>
  <check>
    <ref>title</ref>
  </check>
  <check>
    <id>creator.is.present</id>
  </check>
  <check>
    <id>contact.is.present</id>
  </check>
  <check>
    <id>abstract.100.words</id>
  </check>
  <check>
    <name>One or more NSF award numbers is present</name>
    <description>One or more NSF award numbers must be entered.</description>
    <level>required</level>
    <selector>
      <name>awards</name>
      <xpath>/eml/dataset/project/funding/para</xpath>
    </selector>
    <environment>rscript</environment>
    <code><![CDATA[if (is.null(awards)) {
  status <- "FAILURE"
  output <- "No award numbers were found."
} else if (length(title) < 1) {
  status <- "FAILURE"
  output <- paste0(length(title), " award number(s) found when at least one was expected.")
} else if (any(nchar(awards) <= 0)) {
  status <- "FAILURE"
  output <- paste0("The following award numbers were of zero length: ", which(nchar(awards) <= 0, "."))
} else {
  status <- "SUCCESS"
  output <- paste0("A total of ", length(awards), " valid NSF award number(s) was/were found.")
}]]></code>
  </check>
  <check>
    <name>NSF awards in database</name>
    <description>All entered NSF award numbers are present in the NSF award database.</description>
    <level>required</level>
    <selector>
      <name>awards</name>
      <xpath>/eml/dataset/project/funding/para</xpath>
    </selector>
    <environment>rscript</environment>
    <code><![CDATA[
library(httr)

# Clean up each award string so we can pass it to the HTTP API
awards <- trimws(gsub("nsf award", "", tolower(awards)))

# Search for each award
responses <- lapply(awards, function(award) {
  tryCatch({
    req <- GET(paste0("https://arcticdata.io/api.nsf.gov/services/v1/awards.json?id=", award))
    stopifnot(req$status_code == 200) # Throw an error if the HTTP status isn't 200
    content(req)
  },
  error = function(e) {
    list()
  })
})

# Determine if each award was found
is_found <- sapply(responses, function(r) ifelse(!is.null(r$response$award) && length(r$response$award) == 1, TRUE, FALSE))


if (all(is_found)) {
  status <- "SUCCESS"
  output <- "All award numbers were found in the NSF award database."
} else {

  outputs <- paste0("The award number '", awards[!is_found], "' was not found in the NSF award database.")
  mdq_result <- list(status = "FAILURE",
                     output = lapply(outputs, function(message) { list(value = message)}))
}
]]></code>
  </check>
</mdq:suite>
